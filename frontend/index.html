<!DOCTYPE html>
<html>
<head>
  <title>Bikes Frontend</title>
</head>
<body>
  <h1>Bikes Frontend</h1>
  <div id="bikesList"></div>
  <hr>
  <button onclick="viewAllComponents()">View All Components</button>
  <button onclick="createNewBike()">Add new bike</button>
  <button onclick="createComponent()">Add new component</button>
  <button onclick="toggleComponentAssignmentForm()">Manage Component Assignments</button>

  <!-- Form for creating and deleting component assignments -->
  <div id="componentAssignmentForm" style="display: none;">
    <label for="bikeSelect">Select a Bike:</label>
    <select id="bikeSelect">
      <!-- The options will be dynamically added later -->
    </select>

    <label for="componentSelect">Select a Component:</label>
    <select id="componentSelect">
      <!-- The options will be dynamically added later -->
    </select>

    <button onclick="createComponentAssignment()">Create Component Assignment</button>
  </div>

  <script>
      function toggleComponentAssignmentForm() {
        const componentAssignmentForm = document.getElementById('componentAssignmentForm');
        if (componentAssignmentForm.style.display === 'none') {
          showComponentAssignmentForm();
        } else {
          hideComponentAssignmentForm();
        }
      }

      // Function to show the component assignment form
      function showComponentAssignmentForm() {
        Promise.all([fetch('/bikes'), fetch('/components')])
          .then(responses => Promise.all(responses.map(response => response.json())))
          .then(([bikesData, componentsData]) => {
            if (bikesData.length === 0) {
              alert('No bikes available. Please create a bike first.');
            } else {
              const componentAssignmentForm = document.getElementById('componentAssignmentForm');
              componentAssignmentForm.style.display = 'block';

              const bikeSelect = document.getElementById('bikeSelect');
              bikeSelect.innerHTML = '';

              bikesData.forEach(bike => {
                const option = document.createElement('option');
                option.value = bike.id;
                option.textContent = bike.name;
                bikeSelect.appendChild(option);
              });

              const componentSelect = document.getElementById('componentSelect');
              componentSelect.innerHTML = '';

              componentsData.forEach(component => {
                const option = document.createElement('option');
                option.value = component.id;
                option.textContent = component.name;
                componentSelect.appendChild(option);
              });
            }
          })
          .catch(error => {
            console.error('Error:', error);
            bikesList.textContent = 'Error retrieving data.';
          });
      }

      // Function to hide the component assignment form
      function hideComponentAssignmentForm() {
        const componentAssignmentForm = document.getElementById('componentAssignmentForm');
        componentAssignmentForm.style.display = 'none';
      }

      // Function to create a new component assignment
      function createComponentAssignment() {
        const bikeSelect = document.getElementById('bikeSelect');
        const componentSelect = document.getElementById('componentSelect');

        const selectedBikeId = bikeSelect.value;
        const selectedComponentId = componentSelect.value;

        if (selectedBikeId && selectedComponentId) {
          fetch(`/component_assignments`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              bike_id: parseInt(selectedBikeId),
              component_id: parseInt(selectedComponentId)
            })
          })
            .then(response => {
              if (response.ok) {
                viewAllComponents();
              } else {
                throw new Error('Failed to create component assignment.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error creating component assignment.';
            });
        } else {
          alert('Please select a bike and a component before creating the assignment.');
        }
      }

      // Function to delete a component assignment
      function deleteComponentAssignment() {
        const assignmentId = parseInt(prompt('Enter the ID of the component assignment to delete:'));
        if (assignmentId) {
          fetch(`/component_assignments/${assignmentId}`, {
            method: 'DELETE'
          })
            .then(response => {
              if (response.ok) {
                viewAllComponents();
              } else {
                throw new Error('Failed to delete component assignment.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error deleting component assignment.';
            });
        }
      }


    document.addEventListener('DOMContentLoaded', () => {
      const bikesList = document.getElementById('bikesList');

      // Fetch and display all bikes
      const fetchBikes = () => {
        fetch('/bikes')
          .then(response => response.json())
          .then(data => {
            bikesList.innerHTML = '';
            data.forEach(bike => {
              const bikeItem = document.createElement('div');
              bikeItem.innerHTML = `
                <p>ID: ${bike.id}</p>
                <p>Name: ${bike.name}</p>
                <p>Brand: ${bike.brand}</p>
                <p>Model: ${bike.model}</p>
                <p>Weight: ${bike.weight}</p>
                <p>Notes: ${bike.notes}</p>
                <button onclick="viewComponents(${bike.id})">View Components</button>
                <button onclick="updateBike(${bike.id})">Update</button>
                <button onclick="deleteBike(${bike.id})">Delete</button>
              `;
              bikesList.appendChild(bikeItem);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            bikesList.textContent = 'Error retrieving bikes.';
          });
      };

      // Update a bike
      window.updateBike = bikeId => {
        const newBikeName = prompt('Enter the new name for the bike:');
        if (newBikeName) {
          fetch(`/bikes/${bikeId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: newBikeName })
          })
            .then(response => {
              if (response.ok) {
                fetchBikes();
              } else {
                throw new Error('Failed to update bike.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error updating bike.';
            });
        }
      };

      // Delete a bike
      window.deleteBike = bikeId => {
        if (confirm('Are you sure you want to delete this bike?')) {
          fetch(`/bikes/${bikeId}`, {
            method: 'DELETE'
          })
            .then(response => {
              if (response.ok) {
                fetchBikes();
              } else {
                throw new Error('Failed to delete bike.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error deleting bike.';
            });
        }
      };

      window.viewComponents = bikeId => {
        fetch(`/components?bike_id=${bikeId}`)
          .then(response => response.json())
          .then(data => {
            bikesList.innerHTML = '';
            const backButton = document.createElement('button');
            const createButton = document.createElement('button');

            backButton.textContent = 'Back to Bikes';
            backButton.onclick = fetchBikes;

            bikesList.appendChild(backButton);
            bikesList.appendChild(createButton);

            data.forEach(component => {
              const componentItem = document.createElement('div');
              componentItem.innerHTML = `
                <p>ID: ${component.id}</p>
                <p>Name: ${component.name}</p>
                <p>Brand: ${component.brand}</p>
                <p>Model: ${component.model}</p>
                <p>Weight: ${component.weight}</p>
                <p>Notes: ${component.notes}</p>

                <button onclick="updateComponent(${component.id})">Update</button>
                <button onclick="deleteComponent(${component.id})">Delete</button>
                <button onclick="deleteComponentAssignment()">Delete Component Assignment</button>

              `;
              bikesList.appendChild(componentItem);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            bikesList.textContent = 'Error retrieving components.';
          });
      };

      // Create a new component for a bike
      window.createComponent = () => {
        const componentName = prompt('Enter the name for the new component:');
        const componentBrand = prompt('Enter the brand for the new component:');
        const componentModel = prompt('Enter the model for the new component:');
        const componentWeight = parseFloat(prompt('Enter the weight for the new component:'));
        const componentNotes = prompt('Enter the notes for the new component:');

        if (componentName) {
          fetch(`/components`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: componentName,
              brand: componentBrand,
              model: componentModel,
              weight: componentWeight,
              notes: componentNotes,
            })
          })
            .then(response => {
              if (response.ok) {
                viewAllComponents();
              } else {
                throw new Error('Failed to create component.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error creating component.';
            });
        }
      };

      // View all components
      window.viewAllComponents = () => {
        fetch('/components')
          .then(response => response.json())
          .then(data => {
            bikesList.innerHTML = '';
            const backButton = document.createElement('button');
            backButton.textContent = 'Back to Bikes';
            backButton.onclick = fetchBikes;

            bikesList.appendChild(backButton);

            data.forEach(component => {
              const componentItem = document.createElement('div');
              componentItem.innerHTML = `
                <p>ID: ${component.id}</p>
                <p>Name: ${component.name}</p>
                <p>Bike id: ${component.bike_id}</p>
                <p>Brand: ${component.brand}</p>
                <p>Model: ${component.model}</p>
                <p>Weight: ${component.weight}</p>
                <p>Notes: ${component.notes}</p>
                <hr>
              `;
              bikesList.appendChild(componentItem);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            bikesList.textContent = 'Error retrieving components.';
          });
      };

      // Create a new bike
      window.createNewBike = () => {
        const bikeName = prompt('Enter the name for the new bike:');
        const bikeBrand = prompt('Enter the brand for the new bike:');
        const bikeModel = prompt('Enter the model for the new bike:');
        const bikeWeight = parseFloat(prompt('Enter the weight for the new bike:'));
        const bikeNotes = prompt('Enter the notes for the new bike:');
        if (bikeName) {
          fetch('/bikes', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: bikeName,
              brand: bikeBrand,
              model: bikeModel,
              weight: bikeWeight,
              notes: bikeNotes
            })
          })
            .then(response => {
              if (response.ok) {
                fetchBikes();
              } else {
                throw new Error('Failed to create bike.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              bikesList.textContent = 'Error creating bike.';
            });
        }
      };

      // Fetch and display bikes when the page loads
      fetchBikes();
    });
  </script>
</body>
</html>
